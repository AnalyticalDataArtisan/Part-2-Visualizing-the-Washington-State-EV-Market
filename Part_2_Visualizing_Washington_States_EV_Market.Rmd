---
title: "Part 2: Visualizing the Washington State EV Market"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
---

``` {r}
# Load necessary packages
# dplyr: for data manipulation
# tidyr: 
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(stringr)


# READ IN DATASET

# Load dataset containing variables for EV Population
df <- read.csv("C:/Users/tonyh/OneDrive/Documents/Analytical Data Artisan/Analyst Builder/R/Practice Datasets/Tesla/Electric_Vehicle_Population_Data_04_17_2025.csv")

# Data Cleaning
# Rename columns by replacing . with _ so it doesn't confuse R and take Base.MSRP from character structure to numeric
clean_df <- df |>
  rename_with(~ gsub("\\.","_", .)) |>
  mutate(
    Base_MSRP = as.numeric(Base_MSRP),
    Tesla = ifelse(Make == "TESLA", "TESLA", "OTHER")
  )
  

# What percentage of EVs in Washington State are Teslas? - tesla/all vehicles *100
total_vehicles <- as.numeric(nrow(clean_df))
tesla_vehicles <- as.numeric(nrow(filter(clean_df, Tesla == "TESLA")))

tesla_market_share <- round(tesla_vehicles/total_vehicles * 100, 1)

# Top Tesla Models Selling in Washington State?
make_model_sold <- clean_df |> 
  filter(Tesla == "TESLA") |>
  group_by(Make,Model) |>
  summarise(count_sold = n(), .groups = "drop") |>
  arrange(desc(count_sold))

# MSRP by year
msrp_by_year <- clean_df |>
  filter(Base_MSRP > 0) |>
  filter(Tesla == "TESLA") |>
  group_by(Model_Year, Make, Model) |>
  summarise(Min_MSRP = min(Base_MSRP, na.rm = TRUE)) |>
  arrange(Model_Year, Make, Model)

# There weren't good base_msrp data in this dataset. Supplementing with online data and will default to lowest base price.

# READ IN SUPPLEMENTAL DATASET

# Load dataset containing variables for EV Population
df_tesla_prices <- read.csv("C:/Users/tonyh/OneDrive/Documents/Analytical Data Artisan/Analyst Builder/R/Practice Datasets/Tesla/Tesla_Current_Base_Prices.csv")

# Transform model names to uppercase to ensure matching works during the join
df_tesla_prices <- df_tesla_prices |>
  mutate(
  Model = toupper(Model)
)

# Joined data frames and perform aggregation
top_tesla_model_sales <- make_model_sold |>
  left_join(df_tesla_prices, by = "Model") |>
  mutate(
    # Ensure both columns are numeric before multiplying to avoid coercion issues
    Estimated_Revenue = as.numeric(count_sold) * as.numeric(Base_Price_USD)
  )


# Filter to default lowest base price per model to provide a final estimate of lifetime sales as of April 2025
top_tesla_models_priced <- top_tesla_model_sales |>
  filter(!is.na(Estimated_Revenue)) |>
  group_by(Model) |>
  slice_min(Base_Price_USD) |>
  ungroup()
  

# Tesla Vehicles Sold by Year in Washington State
tesla_sold_by_year <- clean_df |>
  filter(Tesla == "TESLA") |>
  group_by(Model_Year) |>
  summarise(Count = n()) |>
  arrange(Model_Year)


# Tesla vs competitors - Average Range
# MSRP data wasn't 100% provided in the dataset and may skew results
avg_range_for_evs <- clean_df |>
  filter(Electric_Vehicle_Type == "Battery Electric Vehicle (BEV)",
         Electric_Range != 0,
         Base_MSRP != 0) |>
  group_by(Tesla) |>
  summarise(AVG_Range = mean(Electric_Range),
            AVG_MSRP = mean(Base_MSRP))
  

# Tesla vs competitors - Median Range
# MSRP data wasn't 100% provided in the dataset and may skew results
median_range_for_evs <- clean_df |>
  filter(Electric_Vehicle_Type == "Battery Electric Vehicle (BEV)",
         Electric_Range != 0,
         Base_MSRP != 0) |>
  group_by(Tesla) |>
  summarise(Median_Range = median(Electric_Range),
            Median_MSRP = median(Base_MSRP))


# Plug-in Hybrid Electric (PHEV) and Battery Electric Vehicle (BEV) Trends
phev_vs_bev <- clean_df |>
  group_by(Model_Year, Electric_Vehicle_Type) |>
  summarise(Count = n(), .groups = "drop")


# Electric Utilities in Washington State for Tesla
utility_count_for_teslas <- clean_df |>
  filter(Tesla == "TESLA") |>
  group_by(Electric_Utility) |>
  summarise(Count = n(), .groups = "drop") |>
  arrange(desc(Count))
  

# Top 5 Electric Utilities in Washington State for Tesla
top_5_utility_count_for_teslas <- clean_df |>
  filter(Tesla == "TESLA") |>
  group_by(Electric_Utility) |>
  summarise(Count = n(), .groups = "drop") |>
  arrange(desc(Count)) |>
  head(5)

```

### Tesla Market Share in Washington State

``` {r}
# What market share does Tesla have compared to other EV's in Washington State?
market_df <- data.frame(
  Group = c("TESLA", "OTHER"),
  market_share = c(tesla_market_share, 100 - tesla_market_share)
)

# Add a label column to append % sign for display purposes 
market_df <- market_df |>
  mutate(
    Label = paste0(market_share, "%"),
    ypos = cumsum(market_share) - 0.5 * market_share
  )

ggplot(market_df, aes(x = "", y = market_share, fill = Group)) +
  geom_col(width = 1) +
  coord_polar("y") +
  geom_text(aes(y = ypos, label = Label)) +
  labs(title = "Tesla vs. Other EV Makers: Washington Market Share",
    caption = "Last update: April 2025") +
  scale_fill_manual(values = c("TESLA" ="steelblue", "OTHER" = "gray60"), name = "Automaker") +  # Set legend title to "Automaker" instead of using the column name "Group"
  theme_void() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1.47, size = 8, face = "italic")
)


```

### Top Selling Tesla Models in Washington State

```{r}
make_model_sold <- clean_df |> 
  filter(Tesla == "TESLA") |>
  group_by(Make,Model) |>
  summarise(count_sold = n(), .groups = "drop") |>
  arrange(desc(count_sold))

ggplot(make_model_sold, aes(x = reorder(Model, -count_sold), y = count_sold)) +
  geom_col(fill = "steelblue") +
  labs(title = "Top Selling Tesla Models in Washington",
       x = "Model",
       y = "Vehicles Sold",
       caption = "Last update: April 2025") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic")  # right-align caption
)


```

### Estimated Revenue Per Model

``` {r}
top_tesla_models_priced <- top_tesla_model_sales |>
  filter(!is.na(Estimated_Revenue)) |>
  group_by(Model) |>
  slice_min(Base_Price_USD) |>
  ungroup()

ggplot(top_tesla_models_priced, aes(x = reorder(Model, -Estimated_Revenue), y = Estimated_Revenue)) +
  geom_col(fill = "steelblue") +
  labs(title = "Estimated Revenue Per Model",
       x = "Model",
       y = "Vehicles Sold",
       caption = "Last update: April 2025") +
  scale_y_continuous(labels = label_comma()) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic")  # right-align caption
)


```

### Tesla Vehicles Sold by Year in Washington State

```{r}
tesla_sold_by_year <- clean_df |>
  filter(Tesla == "TESLA") |>
  group_by(Model_Year) |>
  summarise(Count = n()) |>
  arrange(Model_Year)
  
ggplot(tesla_sold_by_year, aes(x = Model_Year, y = Count)) +
  geom_line(color = "steelblue", linewidth = 1.3) +
  geom_point(color = "steelblue", size = 3) +
  labs(title = "Tesla Vehicles Sold by Year in Washington",
       x = "Year",
       y = "Count",
       caption = "Last update: April 2025") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic")  # right-align caption
)


```

### Average Electric Range (BEV)

```{r}
avg_range_for_evs <- clean_df |>
  filter(Electric_Vehicle_Type == "Battery Electric Vehicle (BEV)",
         Electric_Range != 0,
         Base_MSRP != 0) |>
  group_by(Tesla) |>
  summarise(AVG_Range = mean(Electric_Range),
            AVG_MSRP = mean(Base_MSRP))

ggplot(avg_range_for_evs, aes(x = Tesla, y = AVG_Range, fill = Tesla)) + 
  geom_col() +
  labs(title = "Average Electric Range (BEV)",
       x = "Brand",
       y = "Average Range",
       caption = "Last update: April 2025") +
  scale_fill_manual(values = c("TESLA" = "steelblue", "OTHER" = "gray60")) +
  theme_minimal() +
  theme(
    legend.position = "none",  # hide legend
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic")  # right-align caption
)


```

### Average MSRP (BEV)

```{r}
avg_range_for_evs <- clean_df |>
  filter(Electric_Vehicle_Type == "Battery Electric Vehicle (BEV)",
         Electric_Range != 0,
         Base_MSRP != 0) |>
  group_by(Tesla) |>
  summarise(AVG_Range = mean(Electric_Range),
            AVG_MSRP = mean(Base_MSRP))

ggplot(avg_range_for_evs, aes(x = Tesla, y = AVG_MSRP, fill = Tesla)) + 
  geom_col() +
  labs(title = "Average MSRP (BEV)",
       x = "Brand",
       y = "Average MSRP",
       caption = "Last update: April 2025") +
  scale_fill_manual(values = c("TESLA" = "steelblue", "OTHER" = "gray60")) +
  theme_minimal() +
  theme(
    legend.position = "none",  # hide legend
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic")  # right-align caption)
)


```

### Plug-in Hybrid Electric (PHEV) and Battery Electric Vehicle (BEV) Trends

```{r}
phev_vs_bev <- clean_df |>
  group_by(Model_Year, Electric_Vehicle_Type) |>
  summarise(Count = n(), .groups = "drop")

# Update the factor levels to use multi-line labels with (BEV)/(PHEV) centered below
phev_vs_bev$Electric_Vehicle_Type <- factor(
  phev_vs_bev$Electric_Vehicle_Type,
  levels = c("Battery Electric Vehicle (BEV)", "Plug-in Hybrid Electric Vehicle (PHEV)"),
  labels = c("Battery Electric Vehicle\n              (BEV)", "Plug-in Hybrid Electric Vehicle\n                  (PHEV)")
)

ggplot(phev_vs_bev, aes(x = Model_Year, y = Count, color = Electric_Vehicle_Type)) +
  geom_line(linewidth = 1.1) +
  geom_point(size = 2) +
  scale_color_manual(values = c(
    "Battery Electric Vehicle\n              (BEV)" = "steelblue",
    "Plug-in Hybrid Electric Vehicle\n                  (PHEV)" = "gray60"
  )) +
  labs(
    title = "PHEV vs BEV Trends Over Time",
    x = "Year",
    y = "Count",
    caption = "Last update: April 2025",
    color = "Electric Vehicle Type"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.margin = margin(t = 10, r = 30, b = 30, l = 10),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic")
  )


```

### Top 5 Tesla Utilities in Washington State

```{r}
utility_count_for_teslas <- clean_df |>
  filter(Tesla == "TESLA") |>
  group_by(Electric_Utility) |>
  summarise(Count = n(), .groups = "drop") |>
  arrange(desc(Count))

# Wrap utility names to 25 characters wide
top_5_utility_count_for_teslas$Electric_Utility <- str_wrap(top_5_utility_count_for_teslas$Electric_Utility, width = 25)

ggplot(top_5_utility_count_for_teslas, aes(x = reorder(Electric_Utility, Count), y = Count)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 5 Tesla Utilities in Washington",
       x = "Utility",
       y = "Tesla Count",
       caption = "Last update: April 2025") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 8),
    plot.title = element_text(hjust = 0.5),
    plot.caption = element_text(hjust = 1, size = 8, face = "italic"),  # right-align caption
)


```

